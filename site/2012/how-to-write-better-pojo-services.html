<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>How to write better POJO Services</title>
        <link rel="stylesheet" href="https://zemian.github.io/theme/css/main.css" />
        <link href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ZBlog Atom Feed" />
        <meta name="description" content="In Java, you can easily implement some business logic in Plain Old Java Object (POJO) classes, and then able to run them in a fancy server or..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://zemian.github.io/">ZBlog</a></h1>
                <nav><ul>
                    <li><a href="https://zemian.github.io/pages/about-the-author.html">About The Author</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://zemian.github.io/2012/how-to-write-better-pojo-services.html" rel="bookmark"
           title="Permalink to How to write better POJO Services">How to write better POJO Services</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2012-09-01T00:00:00-05:00">
                Published: Sat 01 September 2012
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://zemian.github.io/author/zemian-deng.html">Zemian Deng</a>
        </address>
<p>In <a href="https://zemian.github.io/category/blog.html">Blog</a>.</p>
<p>tags: <a href="https://zemian.github.io/tag/java.html">java</a> </p>
</footer><!-- /.post-info -->      <p>In Java, you can easily implement some business logic in Plain Old Java Object (POJO) classes, and then able to run them in a fancy
server or framework without much hassle. There many server/frameworks, such as JBossAS, Spring or Camel etc, that 
would allow you to deploy POJO without even hardcoding to their API. Obviously you would get advance features if you willing to couple to
their API specifics, but even if you do, you can keep these to minimal by encapsulating your own POJO and their API in a wrapper. 
By writing and designing your own application as simple POJO as possible, you will have the most flexible ways in choose a framework or server to 
deploy and run your application. One effective way to write your business logic in these environments is to use <em>Service</em> component. 
In this article I will share few things I learned in writing <em>Services</em>.</p>
<h1>What is a Service?</h1>
<p>The word <em>Service</em> is overly used today, and it could mean many things to different people. When I say <em>Service</em>, my definition is a software 
component that has minimal of life-cycles such as <code>init</code>, <code>start</code>, <code>stop</code>, and <code>destroy</code>. You may not need all these
stages of life-cycles in every service you write, but you can simply ignore ones that don't apply. When writing large application that 
intended for long running such as a server component, definining these life-cycles and ensure they are excuted in proper order is crucial!</p>
<p>I will be walking you through a Java demo project that I have prepared. It's very basic and it should run as stand-alone. The only dependency it has is
the <a href="http://www.slf4j.org">SLF4J</a> logger. If you don't know how to use logger, then simply replace them with <code>System.out.println</code>. However I would strongly 
encourage you to learn how to use logger effectively during application development though. Also if you want to try out the 
<a href="http://www.springsource.org/spring-framework">Spring</a> related demos, then obviously you would need their jars as well.</p>
<h1>Writing basic POJO service</h1>
<p>You can quickly define a contract of a Service with life-cycles as below in an interface.</p>
<div class="highlight"><pre><span></span><code>    package servicedemo;

    public interface Service {
        void init();
        void start();
        void stop();
        void destroy();
        boolean isInited();
        boolean isStarted();
    }
</code></pre></div>

<p>Developers are free to do what they want in their Service implementation, but you might want to give them an adapter class so that 
they don't have to re-write same basic logic on each Service. I would provide an abstract service like this:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">package</span> <span class="n">servicedemo</span><span class="p">;</span>

    <span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.</span><span class="o">*</span><span class="p">;</span>
    <span class="kn">import</span> <span class="nn">org.slf4j.</span><span class="o">*</span><span class="p">;</span>
    <span class="n">public</span> <span class="n">abstract</span> <span class="k">class</span> <span class="nc">AbstractService</span> <span class="n">implements</span> <span class="n">Service</span> <span class="p">{</span>
        <span class="n">protected</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">getClass</span><span class="p">());</span>
        <span class="n">protected</span> <span class="n">AtomicBoolean</span> <span class="n">started</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AtomicBoolean</span><span class="p">(</span><span class="n">false</span><span class="p">);</span>
        <span class="n">protected</span> <span class="n">AtomicBoolean</span> <span class="n">inited</span> <span class="o">=</span> <span class="n">new</span> <span class="n">AtomicBoolean</span><span class="p">(</span><span class="n">false</span><span class="p">);</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">init</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">inited</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">initService</span><span class="p">();</span>
                <span class="n">inited</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> initialized.&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">start</span><span class="p">()</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">Init</span> <span class="n">service</span> <span class="k">if</span> <span class="n">it</span> <span class="n">has</span> <span class="ow">not</span> <span class="n">done</span> <span class="n">so</span><span class="o">.</span>
            <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">inited</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">init</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="o">//</span> <span class="n">Start</span> <span class="n">service</span> <span class="n">now</span><span class="o">.</span>
            <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">started</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">startService</span><span class="p">();</span>
                <span class="n">started</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">true</span><span class="p">);</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> started.&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">stop</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">started</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">stopService</span><span class="p">();</span>
                <span class="n">started</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">false</span><span class="p">);</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> stopped.&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">destroy</span><span class="p">()</span> <span class="p">{</span>
            <span class="o">//</span> <span class="n">Stop</span> <span class="n">service</span> <span class="k">if</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">still</span> <span class="n">running</span><span class="o">.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">started</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">stop</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="o">//</span> <span class="n">Destroy</span> <span class="n">service</span> <span class="n">now</span><span class="o">.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inited</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">destroyService</span><span class="p">();</span>
                <span class="n">inited</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">false</span><span class="p">);</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> destroyed.&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">boolean</span> <span class="n">isStarted</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">started</span><span class="o">.</span><span class="n">get</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">boolean</span> <span class="n">isInited</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">inited</span><span class="o">.</span><span class="n">get</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">String</span> <span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">getClass</span><span class="p">()</span><span class="o">.</span><span class="n">getSimpleName</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;[id=&quot;</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">identityHashCode</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">protected</span> <span class="n">void</span> <span class="n">initService</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">}</span>

        <span class="n">protected</span> <span class="n">void</span> <span class="n">startService</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">}</span>

        <span class="n">protected</span> <span class="n">void</span> <span class="n">stopService</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">}</span>

        <span class="n">protected</span> <span class="n">void</span> <span class="n">destroyService</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>This abstract class provide the basic of most services needs. It has a logger and states to keep track of the life-cycles. It then delegate new
sets of life-cycle methods so subclass can choose to override. Notice that the <code>start()</code> method is checking auto calling <code>init()</code> if it hasn't 
already done so. Same is done in <code>destroy()</code> method to the <code>stop()</code> method. This is important if we're to use it in a container that only have 
two stages life-cycles invocation. In this case, we can simply invoke <code>start()</code> and <code>destroy()</code> to match to our service's life-cycles.</p>
<p>Some frameworks might go even further and create separate interfaces for each stage of the life-cycles, such as <code>InitableService</code> or 
<code>StartableService</code> etc. But I think that would be too much in a typical app. In most of the cases, you want something simple, so I like it just
one interface. User may choose to ignore methods they don't want, or simply use an adaptor class.</p>
<p>Before we end this section, I would throw in a silly Hello world service that can be used in our demo later.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">package</span><span class="w"> </span><span class="n">servicedemo</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="n">HelloService</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="n">AbstractService</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">initService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; inited.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">startService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; started.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">stopService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; stopped.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">public</span><span class="w"> </span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">destroyService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; destroyed.&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>

<h1>Managing multiple POJO Services with a container</h1>
<p>Now we have the basic of <em>Service</em> definition defined, your development team may start writing business logic code! Before long, you will have 
a library of your own services to re-use. To be able group and control these services into an effetive way, we want also provide a container 
to manage them. The idea is that we typically want to control and manage multiple services with a container as a group in a higher level. Here 
is a simple implementation for you to get started:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">package</span> <span class="n">servicedemo</span><span class="p">;</span>

    <span class="kn">import</span> <span class="nn">java.util.</span><span class="o">*</span><span class="p">;</span>
    <span class="n">public</span> <span class="k">class</span> <span class="nc">ServiceContainer</span> <span class="n">extends</span> <span class="n">AbstractService</span> <span class="p">{</span>
        <span class="n">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Service</span><span class="o">&gt;</span> <span class="n">services</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Service</span><span class="o">&gt;</span><span class="p">();</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">setServices</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Service</span><span class="o">&gt;</span> <span class="n">services</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">this</span><span class="o">.</span><span class="n">services</span> <span class="o">=</span> <span class="n">services</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">addService</span><span class="p">(</span><span class="n">Service</span> <span class="n">service</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">this</span><span class="o">.</span><span class="n">services</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">initService</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing &quot;</span> <span class="o">+</span> <span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; with &quot;</span> <span class="o">+</span> <span class="n">services</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; services.&quot;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">Service</span> <span class="n">service</span> <span class="p">:</span> <span class="n">services</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initializing &quot;</span> <span class="o">+</span> <span class="n">service</span><span class="p">);</span>
                <span class="n">service</span><span class="o">.</span><span class="n">init</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; inited.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">startService</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting &quot;</span> <span class="o">+</span> <span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; with &quot;</span> <span class="o">+</span> <span class="n">services</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; services.&quot;</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">Service</span> <span class="n">service</span> <span class="p">:</span> <span class="n">services</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting &quot;</span> <span class="o">+</span> <span class="n">service</span><span class="p">);</span>
                    <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; started.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">stopService</span><span class="p">()</span> <span class="p">{</span>
                <span class="nb">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">size</span><span class="p">();</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping &quot;</span> <span class="o">+</span> <span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; with &quot;</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="s2">&quot; services in reverse order.&quot;</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Service</span> <span class="n">service</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping &quot;</span> <span class="o">+</span> <span class="n">service</span><span class="p">);</span>
                    <span class="n">service</span><span class="o">.</span><span class="n">stop</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; stopped.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">destroyService</span><span class="p">()</span> <span class="p">{</span>
                <span class="nb">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">size</span><span class="p">();</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Destroying &quot;</span> <span class="o">+</span> <span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; with &quot;</span> <span class="o">+</span> <span class="n">size</span> <span class="o">+</span> <span class="s2">&quot; services in reverse order.&quot;</span><span class="p">);</span>
                <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">Service</span> <span class="n">service</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Destroying &quot;</span> <span class="o">+</span> <span class="n">service</span><span class="p">);</span>
                    <span class="n">service</span><span class="o">.</span><span class="n">destroy</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; destroyed.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>From above code, you will notice few important things:</p>
<ol>
<li>We extends the AbstractService, so a container is a service itself.</li>
<li>We would invoke all service's life-cycles before moving to next. No services will start unless all others are inited.</li>
<li>We should stop and destroy services in reverse order for most general use cases.</li>
</ol>
<p>The above container implementation is simple and run in synchronized fashion. This mean, you start container, then all services
will start in order you added them. Stop should be same but in reverse order. </p>
<p>I also hope you would able to see that there is plenty of room for you to improve this container as well. For example, you may 
add thread pool to control the execution of the services in asynchronized fashion.</p>
<h1>Running POJO Services</h1>
<h2>Running services with a simple runner program.</h2>
<p>In the simplest form, we can run our POJO services on our own without any fancy server or frameworks. Java programs start its life from a 
static <code>main</code> method, so we surely can invoke <code>init</code> and <code>start</code> of our services in there. But we also need to address the <code>stop</code> and <code>destroy</code>
life-cycles when user shuts down the program (usually by hitting <code>CTRL+C</code>.) For this, the Java has the <code>java.lang.Runtime#addShutdownHook()</code>
facility. You can create a simple stand-alone server to bootstrap <em>Service</em> like this:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">package</span> <span class="n">servicedemo</span><span class="p">;</span>

    <span class="kn">import</span> <span class="nn">org.slf4j.</span><span class="o">*</span><span class="p">;</span>
    <span class="n">public</span> <span class="k">class</span> <span class="nc">ServiceRunner</span> <span class="p">{</span>
        <span class="n">private</span> <span class="n">static</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">ServiceRunner</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>

        <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ServiceRunner</span> <span class="n">main</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ServiceRunner</span><span class="p">();</span>
            <span class="n">main</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s2">&quot;Missing service class name as argument.&quot;</span><span class="p">);</span>

            <span class="n">String</span> <span class="n">serviceClassName</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating &quot;</span> <span class="o">+</span> <span class="n">serviceClassName</span><span class="p">);</span>
                <span class="n">Class</span><span class="o">&lt;</span><span class="err">?</span><span class="o">&gt;</span> <span class="n">serviceClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="n">forName</span><span class="p">(</span><span class="n">serviceClassName</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">Service</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">isAssignableFrom</span><span class="p">(</span><span class="n">serviceClass</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s2">&quot;Service class &quot;</span> <span class="o">+</span> <span class="n">serviceClassName</span> <span class="o">+</span> <span class="s2">&quot; did not implements &quot;</span> <span class="o">+</span> <span class="n">Service</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">getName</span><span class="p">());</span>
                <span class="p">}</span>
                <span class="n">Object</span> <span class="n">serviceObject</span> <span class="o">=</span> <span class="n">serviceClass</span><span class="o">.</span><span class="n">newInstance</span><span class="p">();</span>
                <span class="n">Service</span> <span class="n">service</span> <span class="o">=</span> <span class="p">(</span><span class="n">Service</span><span class="p">)</span><span class="n">serviceObject</span><span class="p">;</span>

                <span class="n">registerShutdownHook</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Starting service &quot;</span> <span class="o">+</span> <span class="n">service</span><span class="p">);</span>
                <span class="n">service</span><span class="o">.</span><span class="n">init</span><span class="p">();</span>
                <span class="n">service</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">service</span> <span class="o">+</span> <span class="s2">&quot; started.&quot;</span><span class="p">);</span>

                <span class="n">synchronized</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">this</span><span class="o">.</span><span class="n">wait</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">throw</span> <span class="n">new</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s2">&quot;Failed to create and run &quot;</span> <span class="o">+</span> <span class="n">serviceClassName</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">private</span> <span class="n">void</span> <span class="n">registerShutdownHook</span><span class="p">(</span><span class="n">final</span> <span class="n">Service</span> <span class="n">service</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">Runtime</span><span class="o">.</span><span class="n">getRuntime</span><span class="p">()</span><span class="o">.</span><span class="n">addShutdownHook</span><span class="p">(</span><span class="n">new</span> <span class="n">Thread</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Stopping service &quot;</span> <span class="o">+</span> <span class="n">service</span><span class="p">);</span>
                    <span class="n">service</span><span class="o">.</span><span class="n">stop</span><span class="p">();</span>
                    <span class="n">service</span><span class="o">.</span><span class="n">destroy</span><span class="p">();</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">service</span> <span class="o">+</span> <span class="s2">&quot; stopped.&quot;</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>With abover runner, you should able to run it with this command:</p>
<div class="highlight"><pre><span></span><code>$ java demo.ServiceRunner servicedemo.HelloService
</code></pre></div>

<p>Look carefully, and you'll see that you have many options to run multiple services with above runner. Let me highlight couple:</p>
<ol>
<li>Improve above runner directly and make all <code>args</code> for each new service class name, instead of just first element.</li>
<li>Or write a <code>MultiLoaderService</code> that will load multiple services you want. You may control argument passing using System Properties.</li>
</ol>
<p>Can you think of other ways to improve this runner?</p>
<h2>Running services with Spring</h2>
<p>The Spring framework is an IoC container, and it's well known to be easy to work POJO, and Spring lets you wire your application 
together. This would be a perfect fit to use in our POJO services. However, with all the features Spring brings, it missed a easy
to use, out of box <em>main</em> program to bootstrap spring config xml context files. But with what we built so far, this is actually an
easy thing to do. Let's write one of our POJO <em>Service</em> to bootstrap a spring context file.</p>
<div class="highlight"><pre><span></span><code>    <span class="n">package</span> <span class="n">servicedemo</span><span class="p">;</span>

    <span class="kn">import</span> <span class="nn">org.springframework.context.ConfigurableApplicationContext</span><span class="p">;</span>
    <span class="kn">import</span> <span class="nn">org.springframework.context.support.FileSystemXmlApplicationContext</span><span class="p">;</span>

    <span class="n">public</span> <span class="k">class</span> <span class="nc">SpringService</span> <span class="n">extends</span> <span class="n">AbstractService</span> <span class="p">{</span>
        <span class="n">private</span> <span class="n">ConfigurableApplicationContext</span> <span class="n">springContext</span><span class="p">;</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">startService</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">String</span> <span class="n">springConfig</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s2">&quot;springContext&quot;</span><span class="p">,</span> <span class="s2">&quot;spring.xml);</span>
            <span class="n">springContext</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileSystemXmlApplicationContext</span><span class="p">(</span><span class="n">springConfig</span><span class="p">);</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; started.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">stopService</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">springContext</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">this</span> <span class="o">+</span> <span class="s2">&quot; stopped.&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>With that simple <code>SpringService</code> you can run and load any spring xml file. For example try this:</p>
<div class="highlight"><pre><span></span><code>$ java -DspringContext<span class="o">=</span>config/service-demo-spring.xml demo.ServiceRunner servicedemo.SpringService
</code></pre></div>

<p>Inside the <code>config/service-demo-spring.xml</code> file, you can easily create our container that hosts one or more service in Spring beans.</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;helloService&quot;</span> <span class="na">class=</span><span class="s">&quot;servicedemo.HelloService&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>

        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;serviceContainer&quot;</span> <span class="na">class=</span><span class="s">&quot;servicedemo.ServiceContainer&quot;</span> <span class="na">init-method=</span><span class="s">&quot;start&quot;</span> <span class="na">destroy-method=</span><span class="s">&quot;destroy&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;services&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;list&gt;</span>
                    <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;helloService&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/list&gt;</span>
            <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;/beans&gt;</span>
</code></pre></div>

<p>Notice that I only need to setup <code>init-method</code> and <code>destroy-method</code> once on the <code>serviceContainer</code> bean. You can then add one or more
other service such as the <code>helloService</code> as much as you want. They will all be started, managed, and then shutdown when you close the
Spring context.</p>
<p>Note that Spring context container did not explicitly have the same life-cycles as our services. The Spring context will automatically
instanciate all your dependency beans, and then invoke all beans who's <code>init-method</code> is set. All that is done inside the constructor
of <code>FileSystemXmlApplicationContext</code>. No explicit init method is called from user. However at the end, during stop of the service, Spring provide
the <code>springContext#close()</code> to clean things up. Again, they do not differentiate <code>stop</code> from <code>destroy</code>. Because of this, we must merge our
<code>init</code> and <code>start</code> into Spring's <code>init</code> state, and then merge <code>stop</code> and <code>destroy</code> into Spring's <code>close</code> state. Recall our 
<code>AbstractService#destory</code> will auto invoke <code>stop</code> if it hasn't already done so. So this is trick that we need to understand
in order to use Spring effectively.</p>
<h2>Running services with JEE app server</h2>
<p>In a corporate env, we usually do not have the freedom to run what we want as a stand-alone program. Instead they usually have some 
infrustructure and stricter standard technology stack in place already, such as using a JEE application server. In these situation, the most 
portable way to run POJO services is in a <code>war</code> web application. In a Servlet web application, you can write a class that implements 
<code>javax.servlet.ServletContextListener</code> and this will provide you the life-cycles hook via <code>contextInitialized</code> and <code>contextDestroyed</code>.
In there, you can instanciate your <code>ServiceContainer</code> object and call <code>start</code> and <code>destroy</code> methods accordingly.</p>
<p>Here is an example that you can explore:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">package</span> <span class="n">servicedemo</span><span class="p">;</span>
    <span class="kn">import</span> <span class="nn">java.util.</span><span class="o">*</span><span class="p">;</span>
    <span class="kn">import</span> <span class="nn">javax.servlet.</span><span class="o">*</span><span class="p">;</span>
    <span class="n">public</span> <span class="k">class</span> <span class="nc">ServiceContainerListener</span> <span class="n">implements</span> <span class="n">ServletContextListener</span> <span class="p">{</span>
        <span class="n">private</span> <span class="n">static</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">ServiceContainerListener</span><span class="o">.</span><span class="n">class</span><span class="p">);</span>
        <span class="n">private</span> <span class="n">ServiceContainer</span> <span class="n">serviceContainer</span><span class="p">;</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">contextInitialized</span><span class="p">(</span><span class="n">ServletContextEvent</span> <span class="n">sce</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serviceContainer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ServiceContainer</span><span class="p">();</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Service</span><span class="o">&gt;</span> <span class="n">services</span> <span class="o">=</span> <span class="n">createServices</span><span class="p">();</span>
            <span class="n">serviceContainer</span><span class="o">.</span><span class="n">setServices</span><span class="p">(</span><span class="n">services</span><span class="p">);</span>
            <span class="n">serviceContainer</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">serviceContainer</span> <span class="o">+</span> <span class="s2">&quot; started in web application.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">public</span> <span class="n">void</span> <span class="n">contextDestroyed</span><span class="p">(</span><span class="n">ServletContextEvent</span> <span class="n">sce</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serviceContainer</span><span class="o">.</span><span class="n">destroy</span><span class="p">();</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">serviceContainer</span> <span class="o">+</span> <span class="s2">&quot; destroyed in web application.&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Service</span><span class="o">&gt;</span> <span class="n">createServices</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">Service</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Service</span><span class="o">&gt;</span><span class="p">();</span>
            <span class="o">//</span> <span class="n">populate</span> <span class="n">services</span> <span class="n">here</span><span class="o">.</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p>You may configure above in the <code>WEB-INF/web.xml</code> like this:</p>
<div class="highlight"><pre><span></span><code>        <span class="nt">&lt;listener&gt;</span>
            <span class="nt">&lt;listener-class&gt;</span>servicedemo.ServiceContainerListener<span class="nt">&lt;/listener-class&gt;</span>
        <span class="nt">&lt;/listener&gt;</span>

    <span class="nt">&lt;/web-app&gt;</span>
</code></pre></div>

<p>The demo provided a placeholder that you must add your services in code. But you can easily make that configurable using the <code>web.xml</code> for
context parameters.</p>
<p>If you were to use Spring inside a Servlet container, you may directly use their <code>org.springframework.web.context.ContextLoaderListener</code> 
class that does pretty much same as above, except they allow you to specify their xml configuration file using the
<code>contextConfigLocation</code> context parameter. That's how a typical Spring MVC based application is configure. Once you have this setup, you
can experiment our POJO service just as the Spring xml sample given above to test things out. You should see our service in action by
your logger output.</p>
<p>PS: Actually what we described here are simply related to Servlet web application, and not JEE specific. So you can use Tomcat server just
fine as well.</p>
<h1>The importance of Service's life-cycles and it's real world usage</h1>
<p>All the information I presented here are not novelty, nor a killer design pattern. In fact they have been used in many popular open source projects.
However, in my past experience at work, folks always manage to make these extremely complicated, and worse case is that they completely disregard the 
importance of life-cycles when writing services. It's true that not everything you going to write needs to be fitted into a service, but if you find
the need, please do pay attention to them, and take good care that they do invoked properly. The last thing you want is to exit JVM without clean up
in services that you allocated precious resources for. These would become more disastrous if you allow your application to be dynamically reloaded during
deployment without exiting JVM, in which will lead to system resources leakage.</p>
<p>The above <em>Service</em> practice has been put into use in the <a href="https://bitbucket.org/timemachine/scheduler">TimeMachine</a> project. In fact, if you 
look at the <code>timemachine.scheduler.service.SchedulerEngine</code>, it would just be a container of many <a href="https://bitbucket.org/timemachine/scheduler/src/15f066cc6dad/timemachine-scheduler/src/main/java/timemachine/scheduler/service">services</a> 
running together. And that's how user can extend the scheduler functionalities as well, by writing a <em>Service</em>. You can load these services dynamically by a simple properties file.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>