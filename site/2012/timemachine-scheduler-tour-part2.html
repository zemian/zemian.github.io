<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>TimeMachine Scheduler Tour - Part2</title>
        <link rel="stylesheet" href="https://zemian.github.io/theme/css/main.css" />
        <link href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ZBlog Atom Feed" />
        <meta name="description" content="This is part 2 of 7 in a series of articles that will give you a tour of the TimeMachine Scheduler project. These articles will introduce you to..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://zemian.github.io/">ZBlog</a></h1>
                <nav><ul>
                    <li><a href="https://zemian.github.io/pages/about-the-author.html">About The Author</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://zemian.github.io/2012/timemachine-scheduler-tour-part2.html" rel="bookmark"
           title="Permalink to TimeMachine Scheduler Tour - Part2">TimeMachine Scheduler Tour - Part2</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2012-06-10T00:00:00-05:00">
                Published: Sun 10 June 2012
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://zemian.github.io/author/zemian-deng.html">Zemian Deng</a>
        </address>
<p>In <a href="https://zemian.github.io/category/blog.html">Blog</a>.</p>
<p>tags: <a href="https://zemian.github.io/tag/timemachine.html">timemachine</a> </p>
</footer><!-- /.post-info -->      <p>This is part 2 of 7 in a series of articles that will give you a tour of the <a href="https://bitbucket.org/timemachine/scheduler/wiki/Home">TimeMachine Scheduler</a> project. These articles will introduce you to the scheduler, how to load jobs and schedules, and explore some of its advanced features. For the most current and accurate instructions, please visit the ReferenceManual from the project site.</p>
<h2>Scripting the Scheduler with Groovy</h2>
<p>Scripting language is a great way to extend an application, and with Java 6 or higher it has ScriptingEngine API baked right in. There are many solid JVM based scripting engines available out there today. For example Groovy, Ruby or Jython are just few popular open source ones. The TimeMachine Scheduler embraced the easy and flexibility of scripting. I will be covering some of these features in this tour.</p>
<p>Starting JVM 6 or higher, it already comes with JavaScript engine implementation, and there is no external dependency with this. So TimeMachine has default to use "JavaScript" as scripting engine. You may add any other script engine jars in to the "lib" directory and specify the scriptEngineName parameter to change it.</p>
<p>We have found the <a href="http://groovy.codehaus.org/">Groovy</a> scripting engine to be very productive, and its syntax are very similar to Java language itself, but yet very concise and expressive. So we decided to make TimeMachine distribution zip file pre-packaged the Groovy jars for user convenient. (Note that Groovy is only an optional dependency for TimeMachine scheduler itself, and we have properly set our maven pom.xml as such.)</p>
<p>All the demo code in this tour will use Groovy. You are free to choose other engine if you want to explore it further.</p>
<h2>The ScriptingService</h2>
<p>You may initialize the scheduler along with a script file and let it execute and prepare jobs or anything you would need before the scheduler is started. You will start by create a config/scheduler.properties file like this:</p>
<div class="highlight"><pre><span></span><code>timemachine.scheduler.userservice.scriptingService.class = timemachine.scheduler.userservice.ScriptingService

ScriptingService.scriptEngineName = Groovy

ScriptingService.initScript = config/myscript.groovy
</code></pre></div>

<p>In your config/myscript.groovy file, you may try this:</p>
<div class="highlight"><pre><span></span><code>logger.info(&quot;Hello World!&quot;)

logger.info(&quot;I have access to &quot; + scheduler)
</code></pre></div>

<p>Now you can fire off the scheduler:</p>
<div class="highlight"><pre><span></span><code>$ bin/scheduler.sh config/scheduler.properties
</code></pre></div>

<p>You should see the scheduler started with the hello world message printed on log output.</p>
<h2>The Scheduler API</h2>
<p>From above  you can see that we give you two variables to play with in the script. The logger is simple one, and you probably don't do anything more than logging info message. The more interesting one is the scheduler variable. This variable would have full access to the scheduler; it  is an instance of  <a href="http://tmschedulersite-zdeng.rhcloud.com/scheduler-site/timemachine-scheduler/target/site-deploy/timemachine-scheduler/apidocs/timemachine/scheduler/Scheduler.html">timemachine.scheduler.Scheduler</a> class. Let's use this variable to create a cron job in the following Groovy initScript:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">timemachine.scheduler.</span><span class="o">*</span>
<span class="kn">import</span> <span class="nn">timemachine.scheduler.schedule.</span><span class="o">*</span>
<span class="kn">import</span> <span class="nn">timemachine.scheduler.jobtask.</span><span class="o">*</span>

<span class="n">jobDef</span> <span class="o">=</span> <span class="n">new</span> <span class="n">JobDef</span><span class="p">()</span>

<span class="n">jobDef</span><span class="o">.</span><span class="n">setJobTaskClass</span><span class="p">(</span><span class="n">LoggerJobTask</span><span class="o">.</span><span class="n">class</span><span class="p">)</span>

<span class="n">schedule</span> <span class="o">=</span> <span class="n">new</span> <span class="n">CronSchedule</span><span class="p">()</span>
<span class="n">schedule</span><span class="o">.</span><span class="n">setExpression</span><span class="p">(</span><span class="s2">&quot;* * * * * ?&quot;</span><span class="p">)</span>

<span class="n">jobDef</span><span class="o">.</span><span class="n">addSchedule</span><span class="p">(</span><span class="n">schedule</span><span class="p">)</span>

<span class="n">scheduler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">jobDef</span><span class="p">)</span>
</code></pre></div>

<p>The scheduler API is pretty self explanatory, but let me be more explicit to help along. We imported all the packages and classes that we need first, then we created a job definition object. We told it what task to do and how often to do it. We created 3 schedules/jobs that will run the task. We finally scheduled and stored this job definition to the scheduler. These jobs will run according to the schedule (every second) as soon as your scheduler starts. You may verify through the output log.</p>
<p>For convenience sake, we also provide factory classes that can make above program even shorter.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">timemachine.scheduler.</span><span class="o">*</span>
<span class="n">jobDef</span> <span class="o">=</span> <span class="n">JobDefs</span><span class="o">.</span><span class="n">loggerJobDef</span><span class="p">()</span>
<span class="n">jobDef</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Schedules</span><span class="o">.</span><span class="n">cron</span><span class="p">(</span><span class="s2">&quot;* * * * * ?&quot;</span><span class="p">))</span>
<span class="n">scheduler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">jobDef</span><span class="p">)</span>

<span class="c1">## Schedule Types</span>

<span class="n">Besides</span> <span class="n">the</span> <span class="n">CronSchedule</span><span class="p">,</span> <span class="n">we</span> <span class="n">also</span> <span class="n">have</span> <span class="n">RepeatSchedule</span> <span class="ow">and</span> <span class="n">DateListSchedule</span> <span class="n">schedule</span> <span class="n">types</span><span class="o">.</span> <span class="n">We</span> <span class="n">have</span> <span class="n">created</span> <span class="n">a</span> <span class="n">nice</span> <span class="n">factory</span> <span class="n">methods</span> <span class="ow">in</span> <span class="n">Schedules</span> <span class="n">that</span> <span class="k">return</span> <span class="n">one</span> <span class="n">of</span> <span class="n">these</span> <span class="n">schedule</span><span class="o">.</span> <span class="n">For</span> <span class="n">example</span><span class="p">,</span> <span class="n">we</span> <span class="n">may</span> <span class="n">create</span> <span class="n">a</span> <span class="n">minutely</span> <span class="n">repeat</span> <span class="n">schedule</span> <span class="ow">and</span> <span class="n">an</span> <span class="n">explicit</span> <span class="n">date</span> <span class="nb">list</span> <span class="n">schedules</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">initScript</span> <span class="n">like</span> <span class="n">this</span><span class="p">:</span> 

<span class="kn">import</span> <span class="nn">timemachine.scheduler.</span><span class="o">*</span>
<span class="n">jobDef</span> <span class="o">=</span> <span class="n">JobDefs</span><span class="o">.</span><span class="n">osCommandJobDef</span><span class="p">(</span><span class="s2">&quot;cmd.exe /c echo &#39;Hello World.&#39;&quot;</span><span class="p">)</span>
<span class="n">jobDef</span><span class="o">.</span><span class="n">addSchedule</span><span class="p">(</span><span class="n">Schedules</span><span class="o">.</span><span class="n">minutely</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">jobDef</span><span class="o">.</span><span class="n">addSchedule</span><span class="p">(</span><span class="n">Schedules</span><span class="o">.</span><span class="n">datelist</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">Schedules</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="s2">&quot;01/01/2013 08:00:00&quot;</span><span class="p">),</span> <span class="n">Schedules</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="s2">&quot;01/01/2014 08:00:00&quot;</span><span class="p">)]))</span>

<span class="n">scheduler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">jobDef</span><span class="p">)</span>
</code></pre></div>

<p>In above, we have scheduled one job definition with two schedules to run. First one runs every 5 mins, and the second one runs twice on an explicit given dates.</p>
<p>Note: The asterisk in front of left bracket is needed due to Groovy syntax on passing an list object into Java's wildcard variable argument.</p>
<h2>JobTask Types</h2>
<p>Besides the LoggerJobTask and OsCommandJobTask built-in JobTask you have seen above, we also have a powerful ScriptingJobTask that let you build a job task in Groovy code! This means you may add a new job without even compiling Java code! Here is an example of Groovy initScript script that will create a new "scripting" job.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">timemachine.scheduler.</span><span class="o">*</span>
<span class="n">jobDef</span> <span class="o">=</span> <span class="n">JobDefs</span><span class="o">.</span><span class="n">groovyJobDef</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">file= new File(&quot;/tmp/counter.data&quot;)</span>
<span class="s1">if (!file.exists())</span>
<span class="s1">  num = 1</span>
<span class="s1">else</span>
<span class="s1">  num  = file.text.toInteger() + 1</span>
<span class="s1">logger.info(&quot;Incrementing counter $num in $file&quot;)</span>
<span class="s1">file.write(num)</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
<span class="n">jobDef</span><span class="o">.</span><span class="n">addSchedule</span><span class="p">(</span><span class="n">Schedules</span><span class="o">.</span><span class="n">secondly</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="n">run</span> <span class="n">every</span> <span class="n">second</span><span class="o">.</span>

<span class="n">scheduler</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">jobDef</span><span class="p">)</span>
</code></pre></div>

<p>In above example, we created a job that runs every second. The job task will increment a counter in a file and re-save it every time the job runs.</p>
<h2>Pretty Groovy ...</h2>
<p>There you go. Above is your first custom job in TimeMachine Scheduler! The Groovy language is very similar to Java in syntax, yet minus all the noises, so it's very productive. Groovy also access and integrate with existing <a href="http://docs.oracle.com/javase/6/docs/api/">Java API</a> seamlessly, so you may access and control the scheduler with easy. </p>
<p>Interested? Go and <a href="https://bitbucket.org/timemachine/scheduler/downloads">download</a>the scheduler today and give it a try!</p>
<p>End of part 2. You may continue <a href="https://zemian.github.io/2012/06/timemachine-scheduler-tour-part3.html">next tour</a>, or see <a href="https://zemian.github.io/2012/06/timemachine-scheduler-tour-part1.html">previous tour</a>.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>