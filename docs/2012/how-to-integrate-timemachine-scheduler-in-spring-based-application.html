<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>How to integrate TimeMachine Scheduler in Spring based application</title>
        <link rel="stylesheet" href="https://zemian.github.io/theme/css/main.css" />
        <link href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ZBlog Atom Feed" />
        <meta name="description" content="One of the goals for TimeMachine Scheduler is to make use of POJO as friendly as possible so that we can integrate into any IoC container easily...." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://zemian.github.io/">ZBlog</a></h1>
                <nav><ul>
                    <li><a href="https://zemian.github.io/pages/about-the-author.html">About The Author</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://zemian.github.io/2012/how-to-integrate-timemachine-scheduler-in-spring-based-application.html" rel="bookmark"
           title="Permalink to How to integrate TimeMachine Scheduler in Spring based application">How to integrate TimeMachine Scheduler in Spring based application</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2012-08-17T00:00:00-05:00">
                Published: Fri 17 August 2012
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://zemian.github.io/author/zemian-deng.html">Zemian Deng</a>
        </address>
<p>In <a href="https://zemian.github.io/category/blog.html">Blog</a>.</p>
<p>tags: <a href="https://zemian.github.io/tag/timemachine.html">timemachine</a> <a href="https://zemian.github.io/tag/spring.html">spring</a> </p>
</footer><!-- /.post-info -->      <p>One of the goals for <a href="https://bitbucket.org/timemachine/scheduler">TimeMachine Scheduler</a> is to make use of POJO as friendly as possible so that we can integrate into any IoC container easily. I've prepared a demo that will show you how to integrate TimeMachine with <a href="http://www.springsource.org/">Spring</a> based application. </p>
<p>We will mainly focus on the Spring xml config part in this article, so if you don't feel like checking out the  <a href="https://bitbucket.org/timemachine/scheduler-demo/src/fab518eb64ce/scheduler-spring">demo project source code</a> in details, then simply grab the binary package of the  <a href="https://bitbucket.org/timemachine/scheduler-demo/downloads">timemachine-spring-demo.zip</a> and follow along.</p>
<h1>Introducing a tiny Spring Server</h1>
<p>If you don't already have a Spring project going, then take a look at my little Spring server. It can bootstrap any spring configuration xml file and then sits and wait for a <code>CTRL+C</code> to end. Unzip the demo and try it out like this.</p>
<div class="highlight"><pre><span></span><code>$ <span class="nb">cd</span> timemachine-spring-demo
$ bin/run-spring config/hello-spring.xml
</code></pre></div>

<p>You should see a "Hello World!" message printed. Hit <code>CTRL+C</code> to end it. The xml just declares a simple <code>HelloService</code> bean like this.</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;helloService&quot;</span> <span class="na">class=</span><span class="s">&quot;timemachine.spring.HelloService&quot;</span> <span class="na">init-method=</span><span class="s">&quot;run&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span> <span class="na">value=</span><span class="s">&quot;World&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;/beans&gt;</span>
</code></pre></div>

<p>That's your typical Spring declaration file. With this tiny Spring server, you can quickly experiment any POJOs wired up in any way you wish and put them in action.</p>
<h1>Setting up TimeMachine Scheduler beans</h1>
<p>In Java code, you can easily create an instance of the TimeMachine scheduler as follow:</p>
<div class="highlight"><pre><span></span><code>    <span class="nv">SchedulerFactory</span> <span class="nv">schedulerFactory</span> <span class="o">=</span> <span class="nv">new</span> <span class="nv">SchedulerFactory</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">config/scheduler.properties</span><span class="s2">&quot;</span><span class="ss">)</span><span class="c1">;</span>
    <span class="nv">Scheduler</span> <span class="nv">scheduler</span> <span class="o">=</span> <span class="nv">schedulerFactory</span>.<span class="nv">createScheduler</span><span class="ss">()</span><span class="c1">;</span>
    <span class="nv">scheduler</span>.<span class="nv">start</span><span class="ss">()</span><span class="c1">;</span>
    <span class="o">//</span> <span class="k">Then</span> <span class="nv">we</span> <span class="nv">would</span> <span class="nv">also</span> <span class="nv">need</span> <span class="nv">to</span> <span class="k">call</span> <span class="nl">scheduler</span>.<span class="nv">destroy</span><span class="ss">()</span> <span class="nv">before</span> <span class="nv">we</span> <span class="k">exit</span> <span class="nv">the</span> <span class="nv">Java</span> <span class="nv">program</span>. <span class="ss">(</span><span class="nv">eg</span>: <span class="nv">in</span> <span class="nv">shutdownHook</span><span class="ss">)</span>
</code></pre></div>

<p>You can easily translate that into Spring xml config like in <code>config/timemachine-pojo-spring.xml</code>:</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;schedulerFactory&quot;</span> <span class="na">class=</span><span class="s">&quot;timemachine.scheduler.SchedulerFactory&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;constructor-arg</span> <span class="na">value=</span><span class="s">&quot;config/scheduler.properties&quot;</span><span class="nt">&gt;&lt;/constructor-arg&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;scheduler&quot;</span> <span class="na">class=</span><span class="s">&quot;timemachine.scheduler.Scheduler&quot;</span> 
            <span class="na">factory-bean=</span><span class="s">&quot;schedulerFactory&quot;</span> <span class="na">factory-method=</span><span class="s">&quot;createScheduler&quot;</span>
            <span class="na">init-method=</span><span class="s">&quot;start&quot;</span> <span class="na">destroy-method=</span><span class="s">&quot;destroy&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;/beans&gt;</span>
</code></pre></div>

<p>The benefit of using Spring xml is that your scheduler lifecycles would be automatically taken care of without setting any shutdown hook. Running above should give you a plain scheduler started, and pressing <code>CTRL+C</code> should shutdown gracefully. </p>
<h1>Going further with a custom SchedulerFactoryBean</h1>
<p>Now above is not much excitement using Spring since you would still configure the scheduler through <code>config/scheduler.properties</code>. You certainly can load jobs and add custom services there. But if we are going to use Spring, we might as well take full advantage of it to create the Job Definition and Schedule inside the xml config! To do this, I created a simple <code>timemachine.scheduler.spring.SchedulerFactoryBean</code> in my demo project, and you can try it out like this:</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;scheduler&quot;</span> <span class="na">class=</span><span class="s">&quot;timemachine.scheduler.spring.SchedulerFactoryBean&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configPropsUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;config/scheduler.properties&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;autoStart&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;autoAddJobDef&quot;</span> <span class="na">value=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;jobDef01&quot;</span> <span class="na">class=</span><span class="s">&quot;timemachine.scheduler.JobDef&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;jobTaskClassName&quot;</span> <span class="na">value=</span><span class="s">&quot;timemachine.scheduler.jobtask.ScriptingJobTask&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;props&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;map&gt;</span>
                    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;scriptEngineName&quot;</span> <span class="na">value=</span><span class="s">&quot;Groovy&quot;</span><span class="nt">&gt;&lt;/entry&gt;</span>
                    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;scriptText&quot;</span> <span class="na">value=</span><span class="s">&quot;println(&#39;Hello World.&#39;)&quot;</span><span class="nt">&gt;&lt;/entry&gt;</span>
                <span class="nt">&lt;/map&gt;</span>
            <span class="nt">&lt;/property&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;schedules&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;list&gt;</span>              
                    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;timemachine.scheduler.schedule.CronSchedule&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;expression&quot;</span> <span class="na">value=</span><span class="s">&quot;0/3 * * * * ?&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
                    <span class="nt">&lt;/bean&gt;</span>
                <span class="nt">&lt;/list&gt;</span>
            <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;/beans&gt;</span>
</code></pre></div>

<p>Above will create not only the scheduler but also auto manage the lifecycles for you without you explicitly declare it. The factory bean will also auto detect any JobDef and Schedule bean types and add them into the scheduler instance. This would make your scheduler config all in the Spring xml, and it's well integrated.</p>
<p>There is also another similar sample in <code>config/timemachine-spring.xml</code> you may try. It will invoke an external groovy script instead of inline text.</p>
<h1>Going extra mile on exposing TimeMachine Scheduler through JMX</h1>
<p>The TimeMachine doesn't support any JMX instrumentation, however when running with the Spring, you can easily expose any Java interface to the local MBean Server Platform using Spring's MBeanExporter. For example in <code>config/timemachine-jmx-spring.xml</code> you will see:</p>
<div class="highlight"><pre><span></span><code>    <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans</span>
<span class="s">         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd&quot;</span><span class="nt">&gt;</span>

        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;scheduler&quot;</span> <span class="na">class=</span><span class="s">&quot;timemachine.scheduler.spring.SchedulerFactoryBean&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;configPropsUrl&quot;</span> <span class="na">value=</span><span class="s">&quot;config/scheduler.properties&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span> 
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;exporter&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jmx.export.MBeanExporter&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;assembler&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">&quot;org.springframework.jmx.export.assembler.InterfaceBasedMBeanInfoAssembler&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;managedInterfaces&quot;</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;list&gt;</span>
                            <span class="nt">&lt;value&gt;</span>timemachine.scheduler.Scheduler<span class="nt">&lt;/value&gt;</span>
                        <span class="nt">&lt;/list&gt;</span>
                    <span class="nt">&lt;/property&gt;</span>
                <span class="nt">&lt;/bean&gt;</span>
            <span class="nt">&lt;/property&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;beans&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;map&gt;</span>
                    <span class="nt">&lt;entry</span> <span class="na">key=</span><span class="s">&quot;timemachine.scheduler:name=Scheduler&quot;</span> <span class="na">value-ref=</span><span class="s">&quot;scheduler&quot;</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;/map&gt;</span>
            <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;/beans&gt;</span>
</code></pre></div>

<p>Above will start an empty scheduler, and expose the <code>timemachine.scheduler.Scheduler</code> interface to the JMX local server. You may use <code>$JAVA_HOME/bin/jconsole</code> to connect and will see all the methods automatically exposed. There few methods that contains custom java objects that exporter will not able to convert properly, but at least you will get all the lifecycles and some simple getters that available to you.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>