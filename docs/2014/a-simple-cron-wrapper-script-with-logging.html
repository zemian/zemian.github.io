<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>A simple cron wrapper script with logging</title>
        <link rel="stylesheet" href="https://zemian.github.io/theme/css/main.css" />
        <link href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ZBlog Atom Feed" />
        <meta name="description" content="When working with crontab service, one thing I often need is to capture the ouput of the job. Having the job script aware of this output and..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://zemian.github.io/">ZBlog</a></h1>
                <nav><ul>
                    <li><a href="https://zemian.github.io/pages/about-the-author.html">About The Author</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://zemian.github.io/2014/a-simple-cron-wrapper-script-with-logging.html" rel="bookmark"
           title="Permalink to A simple cron wrapper script with logging">A simple cron wrapper script with logging</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-06-04T00:00:00-05:00">
                Published: Wed 04 June 2014
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://zemian.github.io/author/zemian-deng.html">Zemian Deng</a>
        </address>
<p>In <a href="https://zemian.github.io/category/blog.html">Blog</a>.</p>
<p>tags: <a href="https://zemian.github.io/tag/cron.html">cron</a> <a href="https://zemian.github.io/tag/logging.html">logging</a> </p>
</footer><!-- /.post-info -->      <p>When working with crontab service, one thing I often need is to capture the ouput of the job. Having the job script aware of this output and logging is tedious, and often make the script harder to read. So I wrote a shell wrapper that will redirect all job script's STDOUT into a log file. This way I can inspect it when a job has run and the job script can just focus on the task itself. </p>
<div class="highlight"><pre><span></span><code><span class="cp"># file: runcmd.sh</span>
<span class="cp"># Helper/wrapper script to run any command in the crontab env. This script will ensure</span>
<span class="cp"># user profile script is loaded and to log any command output into log files. It also</span>
<span class="cp"># ensure not to print anything to STDOUT to avoid crontab system mail alert.</span>
<span class="cp">#</span>
<span class="cp"># NOTE: be sure to pass in absolute path of the command to be run so it can be found.</span>
<span class="cp">#</span>
<span class="cp"># Usage:</span>
<span class="cp">#   ./runcmd.sh find $HOME/crontab/test.sh            # Simple use case</span>
<span class="cp">#   LOG_NAME=mytest ./runcmd.sh $HOME/crontab/test.sh # Change the log name to something specific</span>
<span class="cp">#</span>

<span class="cp"># Options</span>
<span class="kt">DIR</span><span class="o">=</span><span class="err">`</span><span class="n">dirname</span><span class="w"> </span><span class="n">$0</span><span class="err">`</span><span class="w"></span>
<span class="n">CMD</span><span class="o">=</span><span class="s">&quot;$@&quot;</span><span class="w"></span>
<span class="n">CMD_NAME</span><span class="o">=</span><span class="err">`</span><span class="n">basename</span><span class="w"> </span><span class="n">$1</span><span class="err">`</span><span class="w"></span>
<span class="n">LOG_NAME</span><span class="o">=</span><span class="n">$</span><span class="p">{</span><span class="n">LOG_NAME</span><span class="o">:=</span><span class="n">$CMD_NAME</span><span class="p">}</span><span class="w"></span>
<span class="n">LOG</span><span class="o">=</span><span class="s">&quot;$DIR/logs/$LOG_NAME.log`date +%s`&quot;</span><span class="w"></span>

<span class="cp"># Ensure logs dir exists</span>
<span class="k">if</span><span class="w"> </span><span class="p">[[</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">$DIR</span><span class="o">/</span><span class="n">logs</span><span class="w"> </span><span class="p">]];</span><span class="w"> </span><span class="n">then</span><span class="w"></span>
<span class="w">        </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">$DIR</span><span class="o">/</span><span class="n">logs</span><span class="w"></span>
<span class="n">fi</span><span class="w"></span>

<span class="cp"># Run cron command</span>
<span class="n">source</span><span class="w"> </span><span class="n">$HOME</span><span class="o">/</span><span class="p">.</span><span class="n">bash_profile</span><span class="w"></span>
<span class="n">echo</span><span class="w"> </span><span class="s">&quot;`date` Started cron cmd=$CMD, logname=$LOG_NAME&quot;</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">$LOG</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="w"></span>
<span class="n">$CMD</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">$LOG</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="w"></span>
<span class="n">echo</span><span class="w"> </span><span class="s">&quot;`date` Cron cmd is done.&quot;</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">$LOG</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span><span class="w"></span>
</code></pre></div>

<p>With this wrapper, you can run any shell script and their output will be recorded. For example this job script below will clean up the logs accumulated in our logs folder.</p>
<p>Note that the wrapper will also auto source the ".bash_profile". Often this this is needed if your job script expect all the env variables you already have setup in your login shell scripts.</p>
<div class="highlight"><pre><span></span><code># <span class="nv">file</span>: <span class="nv">remove</span><span class="o">-</span><span class="nv">crontab</span><span class="o">-</span><span class="nv">logs</span>.<span class="nv">sh</span>
<span class="nv">DIR</span><span class="o">=</span>`<span class="k">dirname</span> <span class="mh">$0</span>`<span class="o">/</span><span class="nv">logs</span>
<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">Checking and removing logs in $DIR</span><span class="s2">&quot;</span>
<span class="nv">find</span> <span class="mh">$D</span><span class="nv">IR</span> <span class="o">-</span><span class="nv">type</span> <span class="nv">f</span> <span class="o">-</span><span class="nv">mtime</span> <span class="o">+</span><span class="mi">31</span> <span class="o">-</span><span class="nv">print</span> <span class="o">-</span><span class="nv">delete</span>
<span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">Done</span><span class="s2">&quot;</span>
</code></pre></div>

<p>Now in the crontab file, you may run the job script like this:</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">Clean</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">crontab</span><span class="w"> </span><span class="n">logs</span><span class="w"></span>
<span class="nv">@montly</span><span class="w"> </span><span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="n">crontab</span><span class="o">/</span><span class="n">runcmd</span><span class="p">.</span><span class="n">sh</span><span class="w"> </span><span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="n">crontab</span><span class="o">/</span><span class="n">remove</span><span class="o">-</span><span class="n">crontab</span><span class="o">-</span><span class="n">logs</span><span class="p">.</span><span class="n">sh</span><span class="w"></span>
</code></pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>