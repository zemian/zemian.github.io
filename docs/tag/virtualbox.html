<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>ZBlog - virtualbox</title>
        <link rel="stylesheet" href="https://zemian.github.io/theme/css/main.css" />
        <link href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="ZBlog Atom Feed" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://zemian.github.io/">ZBlog</a></h1>
                <nav><ul>
                    <li><a href="https://zemian.github.io/pages/about-the-author.html">About The Author</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https://zemian.github.io/2018/create-multiple-vms-using-vagrant.html">Create multiple VMs using Vagrant</a></h1>
<footer class="post-info">
        <abbr class="published" title="2018-05-19T00:00:00-05:00">
                Published: Sat 19 May 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://zemian.github.io/author/zemian-deng.html">Zemian Deng</a>
        </address>
<p>In <a href="https://zemian.github.io/category/blog.html">Blog</a>.</p>
<p>tags: <a href="https://zemian.github.io/tag/vagrant.html">vagrant</a> <a href="https://zemian.github.io/tag/virtualbox.html">virtualbox</a> <a href="https://zemian.github.io/tag/vm.html">vm</a> <a href="https://zemian.github.io/tag/ubuntu.html">ubuntu</a> </p>
</footer><!-- /.post-info --><p>Vagrant is a great tool to automate and setup VMs. Here is a config file
that can setup multiple VMs in your own PC to simulate a
controller(admin), db, and app servers farm env. I will setup so that
itâ€™s ready to install Ansible in a the control server, and ensure all
other servers is accessible by a private virtual IP with default python
executable.</p>
<ol>
<li>
<p>Install VirtualBox and Vagrant in your development PC. (These two
    requires elevated admin rights!)</p>
</li>
<li>
<p>Now as normal user open a terminal and run the following:</p>
<div class="highlight"><pre><span></span><code>$ mkdir vm-serversfarm
$ vagrant init ubuntu/xenial64
</code></pre></div>

</li>
</ol>
<p>Now edit <code>Vagrantfile</code> with the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is to setup Ubuntu VM servers</span>
<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">vm_box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu/xenial64&quot;</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;admin&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">admin</span><span class="o">|</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">vm_box</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;ubuntu-xenial-admin&#39;</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.56.200&quot;</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">privileged</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
      <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">        ssh-keygen -f ~vagrant/.ssh/id_rsa -t rsa -N &#39;&#39;</span>
<span class="sh">        cp -v ~vagrant/.ssh/id_rsa.pub /vagrant/admin_id_rsa.pub</span>
<span class="dl">      SCRIPT_DOC</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
      <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">        apt-get update</span>
<span class="sh">        apt-get install -y ansible</span>
<span class="dl">      SCRIPT_DOC</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;db1&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">db1</span><span class="o">|</span>
    <span class="n">db1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">vm_box</span>
    <span class="n">db1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;ubuntu-xenial-db1&#39;</span>
    <span class="n">db1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.56.211&quot;</span>
    <span class="n">db1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;cat /vagrant/admin_id_rsa.pub &gt;&gt; ~vagrant/.ssh/authorized_keys&quot;</span>
    <span class="n">db1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
      <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">        #apt-get update</span>
<span class="sh">        apt-get install -y python</span>
<span class="sh">        apt-get install -y postgresql</span>
<span class="dl">      SCRIPT_DOC</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;app1&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app1</span><span class="o">|</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">vm_box</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;ubuntu-xenial-app1&#39;</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.56.221&quot;</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;cat /vagrant/admin_id_rsa.pub &gt;&gt; ~vagrant/.ssh/authorized_keys&quot;</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
      <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">        #apt-get update</span>
<span class="sh">        apt-get install -y python</span>
<span class="dl">      SCRIPT_DOC</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;app2&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app2</span><span class="o">|</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">vm_box</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;ubuntu-xenial-app2&#39;</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.56.222&quot;</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;cat /vagrant/admin_id_rsa.pub &gt;&gt; ~vagrant/.ssh/authorized_keys&quot;</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
      <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">        #apt-get update</span>
<span class="sh">        apt-get install -y python</span>
<span class="dl">      SCRIPT_DOC</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>

<p>Now you can bring them up by running just this command:</p>
<div class="highlight"><pre><span></span><code>$ vagrant up
</code></pre></div>

<p>When all is done, you may ssh into any box by their name like this</p>
<div class="highlight"><pre><span></span><code>$ vagrant ssh admin
$ <span class="c1"># Or any of other boxes: db1, app1, app2</span>
</code></pre></div>

<h1>Using CentOS VMs</h1>
<div class="highlight"><pre><span></span><code><span class="c1"># This file is to setup CentOS VM servers</span>
<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">vm_box</span> <span class="o">=</span> <span class="s2">&quot;generic/centos7&quot;</span>

  <span class="c1"># Server app1 is the admin server. We will also host the DB server here.</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;app1&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app1</span><span class="o">|</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">vm_box</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;app1&#39;</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.56.201&quot;</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/vagrant_data&quot;</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">      yum install -y python-virtualenv python36 ansible postgresql</span>
<span class="dl">    SCRIPT_DOC</span>
    <span class="n">app1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">privileged</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">      ssh-keygen -f ~vagrant/.ssh/id_rsa -t rsa -N &#39;&#39;</span>
<span class="sh">      cp -v ~vagrant/.ssh/id_rsa.pub /vagrant_data/app1_id_rsa.pub</span>
<span class="dl">    SCRIPT_DOC</span>
  <span class="k">end</span>

  <span class="c1"># Server app2 is a application workhorse server</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;app2&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app2</span><span class="o">|</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">vm_box</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;app2&#39;</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.56.202&quot;</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/vagrant_data&quot;</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">      yum install -y python36</span>
<span class="dl">    SCRIPT_DOC</span>
    <span class="n">app2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">privileged</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">      cat /vagrant_data/app1_id_rsa.pub &gt;&gt; ~vagrant/.ssh/authorized_keys</span>
<span class="sh">      chmod 600 ~vagrant/.ssh/authorized_keys</span>
<span class="sh">      chmod 700 ~vagrant/.ssh</span>
<span class="dl">    SCRIPT_DOC</span>
  <span class="k">end</span>

  <span class="c1"># Server app3 is a application workhorse server</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;app3&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">app3</span><span class="o">|</span>
    <span class="n">app3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">vm_box</span>
    <span class="n">app3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;app3&#39;</span>
    <span class="n">app3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.56.203&quot;</span>
    <span class="n">app3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/vagrant_data&quot;</span>
    <span class="n">app3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">      yum install -y python36</span>
<span class="dl">    SCRIPT_DOC</span>
    <span class="n">app3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">privileged</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="o">&lt;&lt;-</span><span class="dl">SCRIPT_DOC</span>
<span class="sh">      cat /vagrant_data/app1_id_rsa.pub &gt;&gt; ~vagrant/.ssh/authorized_keys</span>
<span class="sh">      chmod 600 ~vagrant/.ssh/authorized_keys</span>
<span class="sh">      chmod 700 ~vagrant/.ssh</span>
<span class="dl">    SCRIPT_DOC</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://zemian.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>